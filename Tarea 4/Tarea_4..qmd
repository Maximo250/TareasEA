---
title: "Tarea 4. Estimación por el Método de Momentos"
Autor: Màximo Quiroz Sànchez 
lang: es
format:
  html:
    toc: false
    theme: cosmo
    code-fold: true
    fig-width: 6
    fig-height: 4
    fontsize: 1.1rem
    grid:
      sidebar-width: 250px
      body-width: 950px
      margin-width: 250px
      gutter-width: 1.5rem
---

```{=html}
<style>
main.content {
text-align: justify}
</style>
```

```{r}
#| include: false

library(tidyverse)
library(knitr)
library(kableExtra)
library(readxl)
library(RColorBrewer)
```

## **Ejercicio 1 (Resuelto de ejemplo en el enunciado)**

---

## **Ejercicio 2**

::: {#exr-discreta_2}

Para $0 < \theta < 6/5$, la función de probabilidad es:

\[
f(x;\theta) =
\begin{cases}
\theta/2 & \text{si } x = -1 \\
\theta/3 & \text{si } x = 0 \\
1-5\theta/6 & \text{si } x = 1 \\
0 & \text{en otro caso}
\end{cases}
\]

**a) Estimador método de momentos**

\[
E(X) = (-1)\theta/2 + 0\cdot \theta/3 + 1\cdot (1-5\theta/6) = 1 - 4\theta/3
\]
Igualando $\overline{X} = 1 - 4\hat\theta/3$:
\[
\hat\theta = \frac{3(1-\overline{X})}{4}
\]

**b) Insesgamiento**

\[
E(\hat\theta) = E\left(\frac{3(1-\overline{X})}{4}\right) = \theta
\]
El estimador es insesgado.

**c) Varianza**

\[
Var(X) = E(X^2) - [E(X)]^2
\]
\[
E(X^2) = 1\cdot{\theta/2} + 0 + 1\cdot(1-5\theta/6) = \theta/2 + 1 - 5\theta/6 = 1-\theta/3
\]
\[
[E(X)]^2 = \left(1-\frac{4\theta}{3}\right)^2
\]
\[
Var(X) = 1-\theta/3 - (1-\frac{8\theta}{6}+\frac{16\theta^2}{9}) = \frac{-\theta^2+6\theta}{9}
\]
\[
Var(\hat\theta) = \left(\frac{3}{4}\right)^2\frac{\text{Var}(X)}{n} = \frac{-\theta^2+6\theta}{16n}
\]

**d) ECM**

\[
ECM(\hat\theta) = Var(\hat\theta) = \frac{-\theta^2+6\theta}{16n}
\]

**e) Simulación y comparación**

```{r}
theta_fijo <- 1
dexr <- function(x, theta){
  f_x <-ifelse(x == -1, theta/2, ifelse(x == 0, theta/3, ifelse(x == 1, 1-5*theta/6, 0)))
  return(f_x)
}
rexr <- function(n, theta){
  X <- sample(c(-1, 0, 1), size = n, replace = TRUE, prob = c(theta/2, theta/3, 1-5*theta/6))
  return(X)
}
estimar_theta <- function(X){
  theta_hat <- (3*(1-mean(X)))/4
  return(theta_hat)
}
set.seed(123)
df_exr <- data.frame(X = rexr(1000, theta_fijo), Tipo = "Teórico")
theta_hat <- estimar_theta(df_exr$X)
df_temp <- data.frame(X = rexr(1000, theta_hat), Tipo = "Estimados")
df_exr <- rbind(df_exr, df_temp)

ggplot(df_exr)+
  geom_histogram(aes(x = X, y = after_stat(density), fill =Tipo), bins = 3,
                 center = -1, color = "black", alpha = 0.7, position ="dodge")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
```

**f) Convergencia**

```{r}
tamano <- c(10, 50, 100, 500, 1000)
N <- 500
df_convergencia <- data.frame()
for (n in tamano){
  estimacion_n <- replicate(N, {
    X <- rexr(n, theta_fijo)
    estimar_theta(X)
  })
  df_temp <- data.frame(n = as.factor(n), Estimacion = estimacion_n)
  df_convergencia <- rbind(df_convergencia, df_temp)
}
ggplot(df_convergencia)+
  geom_boxplot(aes(x = n, y = Estimacion, fill = n), alpha = 0.7)+
  geom_hline(yintercept = theta_fijo, color = "red", linetype = "dashed", linewidth = 1)+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "Convergencia del estimador al aumentar el tamaño de la muestra",
       x = "Tamaño de la muestra (n)",
       y = "Estimación de θ")+
  theme_bw()+
  theme(legend.position = "none")
```

:::

---

## **Ejercicio 3**

::: {#exr-discreta_3}

$0 < \theta < 3/2$, función de probabilidad:

\[
f(x;\theta) =
\begin{cases}
\theta/3 & x=0\\
1-2\theta/3 & x=1\\
\theta/3 & x=2\\
0 & \text{otro}
\end{cases}
\]

**a) Estimador método de momentos**

\[
E(X) = 0\cdot\theta/3 + 1\cdot(1-2\theta/3)+2\cdot(\theta/3) = 1-2\theta/3+2\theta/3 = 1
\]
¡Así que el valor esperado de $X$ es independientemente de $\theta$!  
Esto significa que *usando solo el primer momento, el método de momentos no permite estimar $\theta$*. Se requiere de un segundo momento. Calculamos $E(X^2)$:

\[
E(X^2) = 0^2 \cdot \theta/3 + 1^2 \cdot (1-2\theta/3) + 4\cdot (\theta/3) = 1-2\theta/3 + 4\theta/3 = 1+2\theta/3
\]

Sean $\overline{X}$ y $m_2$ la media y el segundo momento muestral,
sabemos que $E(X^2) = 1+2\theta/3$, así que igualando $m_2 = 1+2\hat\theta/3$,
\[
\hat\theta = \frac{3(m_2-1)}{2}
\]
Te dejo el código de simulación y estimación usando los dos momentos.

**b-d) Insesgamiento, varianza y ECM**

Con $m_2$ insesgado para $E(X^2)$, entonces $\hat\theta$ es insesgado.
La varianza se calcula como:
\[
Var(\hat\theta) = \left(\frac{3}{2}\right)^2 \frac{Var(X^2)}{n} 
\]
donde $Var(X^2) = E[(X^2)^2]-[E(X^2)]^2$

\[
E[(X^2)^2]=0^4(\theta/3) + 1^4(1-2\theta/3) + 2^4(\theta/3) = (1-2\theta/3)+16(\theta/3) = 1-2\theta/3+16\theta/3=1+14\theta/3
\]
Así,
\[
Var(X^2) = [1+\frac{14\theta}{3}]-[1+\frac{2\theta}{3}]^2
\]
Y puedes poner en código este cálculo.

**e) y f) Simulación y convergencia**

```{r}
theta_fijo <- 1
dexr <- function(x, theta){
  f_x = ifelse(x==0, theta/3,
              ifelse(x==1, 1-2*theta/3,
              ifelse(x==2, theta/3, 0)))
  return(f_x)
}
rexr <- function(n, theta){
  X <- sample(0:2, size=n, replace=TRUE, prob=c(theta/3,1-2*theta/3,theta/3))
  return(X)
}
estimar_theta <- function(X){
  m2 <- mean(X^2)
  theta_hat <- (3*(m2-1))/2
  return(theta_hat)
}
set.seed(123)
df_exr <- data.frame(X = rexr(1000, theta_fijo), Tipo = "Teórico")
theta_hat <- estimar_theta(df_exr$X)
df_temp <- data.frame(X = rexr(1000, theta_hat), Tipo = "Estimados")
df_exr <- rbind(df_exr, df_temp)
ggplot(df_exr)+
  geom_histogram(aes(x = X, y = after_stat(density), fill =Tipo), bins = 3,
                 center = 0, color = "black", alpha = 0.7, position ="dodge")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
```

Convergencia:

```{r}
tamano <- c(10, 50, 100, 500, 1000)
N <- 500
df_convergencia <- data.frame()
for (n in tamano){
  estimacion_n <- replicate(N, {
    X <- rexr(n, theta_fijo)
    estimar_theta(X)
  })
  df_temp <- data.frame(n = as.factor(n), Estimacion = estimacion_n)
  df_convergencia <- rbind(df_convergencia, df_temp)
}
ggplot(df_convergencia)+
  geom_boxplot(aes(x = n, y = Estimacion, fill = n), alpha = 0.7)+
  geom_hline(yintercept = theta_fijo, color = "red", linetype = "dashed", linewidth = 1)+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "Convergencia del estimador al aumentar el tamaño de la muestra",
       x = "Tamaño de la muestra (n)",
       y = "Estimación de θ")+
  theme_bw()+
  theme(legend.position = "none")
```

:::

---

## **Ejercicio 4**

::: {#exr-discreta_4}

$f(x;\theta) = \frac{2x}{\theta(\theta+1)}; x=1,\ldots,\theta$, $\theta\in\mathbb{N}$

### a) Estimador

Primero calculamos la esperanza:
\[
E(X) = \frac{2}{\theta(\theta+1)} \sum_{x=1}^{\theta} x^2 = \frac{2}{\theta(\theta+1)}\cdot \frac{\theta(\theta+1)(2\theta+1)}{6} = \frac{2\theta+1}{3}
\]
Así,
\[
\overline{X} = \frac{2\theta+1}{3} \implies \hat{\theta} = \frac{3\overline{X}-1}{2}
\]

### b) Insesgamiento

\[
E(\hat{\theta}) = \frac{3E(X)-1}{2} = \theta
\]
Es insesgado.

### c) Varianza

Calculamos $Var(X)$:
\[
E(X^2) = \frac{2}{\theta(\theta+1)} \sum_{x=1}^\theta x^3 = \frac{2}{\theta(\theta+1)}\cdot \left(\frac{\theta^2(\theta+1)^2}{4}\right) = \frac{\theta^2(\theta+1)^2}{2\theta(\theta+1)} = \frac{\theta(\theta+1)}{2}
\]
\[
E(X)^2 = \left(\frac{2\theta+1}{3}\right)^2
\]
\[
Var(X) = E(X^2) - [E(X)]^2
\]

Así que:
\[
Var(\hat{\theta}) = \left(\frac{3}{2}\right)^2 \frac{Var(X)}{n}
\]

Código (se calcula todo numéricamente):

```{r}
theta_fijo <- 10
dexr <- function(x, theta){
  f_x <- 2*x/(theta*(theta+1))
  return(f_x)
}
rexr <- function(n, theta){
  X <- sample(1:theta, size=n, replace=TRUE, prob=dexr(1:theta, theta))
  return(X)
}
estimar_theta <- function(X){
  theta_hat <- (3*mean(X)-1)/2
  return(theta_hat)
}
set.seed(234)
df_exr <- data.frame(X = rexr(1000, theta_fijo), Tipo = "Teórico")
theta_hat <- estimar_theta(df_exr$X)
cat("El valor estimado del parámetro es:", round(theta_hat,4), "\n")
df_temp <- data.frame(X = rexr(1000, theta_hat), Tipo = "Estimados")
df_exr <- rbind(df_exr, df_temp)
ggplot(df_exr)+
  geom_histogram(aes(x = X, y = after_stat(density), fill =Tipo), binwidth = 1,
                 center = 1, color = "black", alpha = 0.7, position ="dodge")+
  scale_fill_brewer(palette = "Set1")+
  theme_bw()
```

Convergencia:

```{r}
tamano <- c(10, 50, 100,150, 500, 1000)
N <- 500
df_convergencia <- data.frame()
for (n in tamano){
  estimacion_n <- replicate(N, {
    X <- rexr(n, theta_fijo)
    estimar_theta(X)
  })
  df_temp <- data.frame(n = as.factor(n), Estimacion = estimacion_n)
  df_convergencia <- rbind(df_convergencia, df_temp)
}
ggplot(df_convergencia)+
  geom_boxplot(aes(x = n, y = Estimacion, fill = n), alpha = 0.7)+
  geom_hline(yintercept = theta_fijo, color = "red", linetype = "dashed", linewidth = 1)+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "Convergencia del estimador al aumentar el tamaño de la muestra",
       x = "Tamaño de la muestra (n)",
       y = "Estimación de θ")+
  theme_bw()+
  theme(legend.position = "none")
```

:::

---

## **EJERCICIO CONTINUO 1**

Resuelto en el enunciado.

---

## **EJERCICIO CONTINUO 2**

::: {#exr-continua_2}
Considera la exponencial desplazada $f(x;\theta) = e^{-(x-\theta)}$ para $x\ge\theta$

**a) Estimador**

Para la variable,
\[
E(X) = \theta + 1\implies \hat{\theta} = \overline{X}-1
\]

**b-d) Insesgamiento, varianza, ECM**

\[
E(\hat{\theta}) = E(\overline{X})-1 = E(X)-1 = \theta
\]

\[
Var(X) = 1 \implies Var(\hat{\theta}) = \frac{1}{n}
\]
y así $ECM = Var$.

**e) Simulación y comparación**

```{r}
theta_fijo <- 3
rexr <- function(n, theta){
  X <- -(log(runif(n))) + theta
  return(X)
}
estimar_theta <- function(X){
  theta_hat <- mean(X)-1
  return(theta_hat)
}
set.seed(21)
df_exr <- data.frame(X = rexr(1000, theta_fijo))
theta_hat <- estimar_theta(df_exr$X)

ggplot(df_exr)+
  geom_histogram(aes(x = X, y = after_stat(density)), bins = 30,
                 color = "black", fill = "coral3", alpha = 0.7)+
  stat_function(fun = function(x) dexp(x-theta_hat), color = "blue", linewidth = 1, n = 1000, xlim = c(theta_hat, theta_hat+8))+
  annotate("text", x = theta_hat+2, y = 0.3, label = paste("θ =", round(theta_hat,3)), color = "blue", size = 5)+
  labs(title = "Histograma y densidad paramétrica estimada", x = "x", y = "Densidad")+
  theme_minimal()
```

Convergencia:

```{r}
tamano <- c(10, 50, 100, 500, 1000)
N <- 500
df_convergencia <- data.frame()
for (n in tamano){
  estimacion_n <- replicate(N, {
    X <- rexr(n, theta_fijo)
    estimar_theta(X)
  })
  df_temp <- data.frame(n = as.factor(n), Estimacion = estimacion_n)
  df_convergencia <- rbind(df_convergencia, df_temp)
}
ggplot(df_convergencia)+
  geom_boxplot(aes(x = n, y = Estimacion, fill = n), alpha = 0.7)+
  geom_hline(yintercept = theta_fijo, color = "red", linetype = "dashed", linewidth = 1)+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "Convergencia del estimador al aumentar el tamaño de la muestra",
       x = "Tamaño de la muestra (n)",
       y = "Estimación de θ")+
  theme_bw()+
  theme(legend.position = "none")
```
:::

---

## **EJERCICIO CONTINUO 3**

::: {#exr-continua_3}
Para $f(x;\theta)=\theta x^{\theta-1}$ en $(0,1)$,\\
$E(\log X) = -1/\theta \implies \hat{\theta} = -1/\overline{\log(X)}$

```{r}
theta_fijo <- 2
rexr <- function(n, theta){
  X <- runif(n)^(1/theta)
  return(X)
}
estimar_theta <- function(X){
  theta_hat <- -1/mean(log(X))
  return(theta_hat)
}
set.seed(10)
df_exr <- data.frame(X = rexr(3000, theta_fijo))
theta_hat <- estimar_theta(df_exr$X)

ggplot(df_exr)+
  geom_histogram(aes(x = X, y = after_stat(density)), bins = 30,
                 color = "black", fill = "coral3", alpha = 0.7)+
  stat_function(fun = function(x) theta_hat * x^(theta_hat-1), color = "blue", linewidth = 1, n = 1000, xlim = c(0, 1))+
  annotate("text", x = 0.5, y = 2, label = paste("θ =", round(theta_hat,3)), color = "blue", size = 5)+
  labs(title = "Histograma y densidad paramétrica estimada", x = "x", y = "Densidad")+
  theme_minimal()
```

Convergencia:

```{r}
tamano <- c(10, 50, 100, 500, 1000)
N <- 500
df_convergencia <- data.frame()
for (n in tamano){
  estimacion_n <- replicate(N, {
    X <- rexr(n, theta_fijo)
    estimar_theta(X)
  })
  df_temp <- data.frame(n = as.factor(n), Estimacion = estimacion_n)
  df_convergencia <- rbind(df_convergencia, df_temp)
}
ggplot(df_convergencia)+
  geom_boxplot(aes(x = n, y = Estimacion, fill = n), alpha = 0.7)+
  geom_hline(yintercept = theta_fijo, color = "red", linetype = "dashed", linewidth = 1)+
  scale_fill_brewer(palette = "Set1")+
  labs(title = "Convergencia del estimador al aumentar el tamaño de la muestra",
       x = "Tamaño de la muestra (n)",
       y = "Estimación de θ")+
  theme_bw()+
  theme(legend.position = "none")
```
:::

---

## **Ejercicio Continuo 4**

Resuelto en el enunciado.

---

## **Ejercicios con datos reales**

```{r}
datos <- read_xlsx("./Tarea_4.xlsx")
```

**1. Geométrica:**

```{r}
# Estimador por momentos para θ (La geométrica cuenta éxitos hasta el primer "fallo", por convención E(X)=1/p)
# Con $E(X)=1/θ \implies \hat{\theta}=1/\bar{X}$

theta_hat <- 1/mean(datos$Geometrica)
theta_hat

ggplot(datos)+
  geom_histogram(aes(Geometrica, y = after_stat(density)), binwidth = 1, color = "black", fill = "coral3", alpha = 0.6, boundary=0)+
  stat_function(fun = function(x) dgeom(x-1, prob = theta_hat), color = "blue", linewidth = 1)+
  annotate("text", x = 10, y = 0.2, label = paste("θ =", round(theta_hat, 3)), color = "blue", size = 5)+
  labs(title = "Histograma y pmf estimada (Geométrica)",
       x = "Valores",
       y = "Densidad")+
  theme_minimal()
```

---

**2. Exponencial:**

Enunciado ya contiene la solución.

```{r}
lambda_hat <- 1/mean(datos$Exp)
lambda_hat

ggplot(datos)+
  geom_histogram(aes(Exp, y = after_stat(density)), bins = 50, color = "black", fill = "coral3", alpha = 0.7, boundary=0)+
  stat_function(fun = dexp, args = list(rate = lambda_hat), color = "blue", linewidth = 1) +
  annotate("text", x = 0.75, y = 2, label = paste("λ =", round(lambda_hat, 3)), color = "blue", size = 5)+
  labs(title = "Histograma de datos y función de densidad estimada",
       x = "Valores",
       y = "Densidad") +
  theme_minimal()
```

---

**3. Normal:**

```{r}
mu_hat <- mean(datos$Normal)
sigma2_hat <- mean((datos$Normal - mu_hat)^2)
mu_hat; sigma2_hat

ggplot(datos)+
  geom_histogram(aes(Normal, y = after_stat(density)), bins = 50, color = "black", fill = "coral3", alpha = 0.7)+
  stat_function(fun = dnorm, args = list(mean=mu_hat, sd=sqrt(sigma2_hat)), color = "blue", linewidth = 1) +
  annotate("text", x = mu_hat, y = 0.2, label = paste("mu =", round(mu_hat,2), "sigma^2 =", round(sigma2_hat,2)), color = "blue", size = 5)+
  labs(title = "Normal: Histograma vs densidad estimada", x = "Valores", y = "Densidad") +
  theme_minimal()
```

---

**4. Gamma:**

Si $E(X)=\gamma/\lambda$, $Var(X)=\gamma/\lambda^2$:

\[
\bar{X} = \gamma/\lambda, \qquad s^2 = \gamma/\lambda^2
\implies \lambda = \bar{X}/s^2, \quad \gamma = (\bar{X})^2/s^2
\]

```{r}
media <- mean(datos$Gamma)
varianza <- var(datos$Gamma)
gamma_hat <- (media^2)/varianza
lambda_hat <- media/varianza
gamma_hat; lambda_hat

ggplot(datos)+
  geom_histogram(aes(Gamma, y = after_stat(density)), bins = 50, color = "black", fill = "coral3", alpha = 0.7)+
  stat_function(fun = dgamma, args = list(shape=gamma_hat, rate=lambda_hat), color = "blue", linewidth = 1)+
  annotate("text", x = media, y = 0.2, label = paste("gamma =", round(gamma_hat,2), "lambda =", round(lambda_hat,2)), color = "blue", size = 5)+
  labs(title = "Gamma: Histograma vs densidad estimada", x = "Valores", y = "Densidad") +
  theme_minimal()
```

---